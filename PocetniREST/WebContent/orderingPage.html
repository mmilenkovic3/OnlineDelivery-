<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Customer - ordering </title>
<style>


</style>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<div>

 <button id="back"  style="width:100%;"  class="btn btn-warning" onclick="back()" value="Back"> Back</button>
 <h2 style="text-align: center; font-size:18px;"> New order, Please select restaurant: </h2>
 <select id="restaurantOption" onchange="showArticle(this.value)" class="form-control"> </select> 
<div id="divdiv">

<table id="articleForOrder"  class="table table-bordered">
	<tr>
		<th> Name </th>
		<th> Price </th>
		<th> Type </th>
		<th></th>
	</tr>
	<tbody id="tableBody">
	
	</tbody>
</table>
<br>
<h2 style="text-align: center; font-size:18px;"> Backet: </h2>

<table id="articlePursh"  class="table table-bordered">
	<tr>
		<th> Name </th>
		<th> Price </th>
		<th> Type </th>
		<th> Quantity </th>
	</tr>
	<tbody id="tableBodyPursh">
	
	</tbody>
</table>

</div>
<div>
	<table class="table table-bordered">
	<!-- scope je atribut koji se koristi sa th, proveriti sta se ovde htelo -->
	<tr scope="row">
	<td style="text-align: center;" scope="col"><label id="sumPrice"> 0 </label></td>
	<td  scope="col"><button id="back"  style="width:100%;"  class="btn btn-warning" onclick="create()" > Create order </button> </td>
	</tr>
	</table>
</div>

</div>

<script>
var restaurantList;
var articles;
var ordered; 
var price = 0;

var orderList = [];
loggedUser = getLoggedUser();

function getLoggedUser() {

	var user = null;

	$.ajax({
		async : false,
		url : "rest/users/getLoggedUser",
		type : 'GET',
		dataType : 'json',
		success : function(data) {
			if (data) {
				user = data;
			}
		},
		error : function(errorThrown) {
			toastr.error(errorThrown.responseText);
		}
	});
	return user;
}

$(document).ready(function(){
	
	$.ajax({
		async : false,
		url : "rest/restaurant/getAllRestaurant",
		type : 'GET',
		dataType : 'json',
		success : function(data) {
			if (data) {
				restaurantList = data;
				
				$('#restaurantOption').append($('<option>', { 
			        value: 0,
			        text : "Select restaurant.."
			    }));
				
				$.each(restaurantList, function (i, item) {
					if(item.status == "OPEN")
						{
						 $('#restaurantOption').append($('<option>', { 
						        value: item.id,
						        text : item.name 
						    }));
						}
				   
				});
			}
		},
		error : function(errorThrown) {
			toastr.error(errorThrown.responseText);
		}
	});
	
	})
function back()
{
		window.location.replace("customer.html");
}
	

function showArticle(id)
{
	$.ajax({
		async : false,
		type : "POST",
		url : "rest/article/getArticleByIDRest",
		dataType : 'json',
		contentType : "application/json",
		data : JSON.stringify({
			idRestaurant: id
		}),
			
		success : function(data) {
			articles = data;
				},
		error : function(message) {
			console.log("Udje u error.");
			$('#error').text(message);
			$('#error').show().delay(3000).hide();
			}
		});
	
	console.log(articles);
	var tableHeaderRowCount = 1;
	var table = document.getElementById('articleForOrder');
	var rowCount = table.rows.length;
	for (var i = tableHeaderRowCount; i < rowCount; i++) {
	    table.deleteRow(tableHeaderRowCount);
	}
	
	var tableHeaderRowCount = 1;
	var table = document.getElementById('articlePursh');
	var rowCount = table.rows.length;
	for (var i = tableHeaderRowCount; i < rowCount; i++) {
	    table.deleteRow(tableHeaderRowCount);
	}
	
	orderList = [];
	
	
	
	var data;
	for(let i = 0; i <= articles.length-1; i++)
	{		
		  data += '<tr scope="row">';
	      data += '<td scope="col">'+articles[i].name +'</td>';
	      data += '<td scope="col">'+articles[i].price+' RSD </td>';
	      if(articles[i].type == "DRINK")
	    	  data += '<td scope="col"> Drink </td>';
	      
	      else
	    	  data += '<td scope="col"> Food </td>';
	      
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="addNewArt(articles['+i+']); return false;"> + 1 </td>';
	     
	    	  data += '<tr>';
	   
		
	}
	 
   $('#tableBody').append(data);	
	
	
}

function addNewArt(article)
{
	var exists = 0;
	
	for(let k=0; k <= orderList.length-1; k++)
		{
			if(orderList[k][0].idArticle == article.idArticle)
				{
					var num = orderList[k][1] + 1;
					orderList[k][1] = num;	
					price += article.price;

					document.getElementById("sumPrice").innerHTML = price; 
					exists = 1;
					break;
				}
			
		}
	if(exists == 0)
		{
			orderList.push([article, 1]);
			price += article.price;
			console.log(price);
			document.getElementById("sumPrice").innerHTML = price; 
			
		}	
	
	var tableHeaderRowCount = 1;
	var table = document.getElementById('articlePursh');
	var rowCount = table.rows.length;
	for (var i = tableHeaderRowCount; i < rowCount; i++) {
	    table.deleteRow(tableHeaderRowCount);
	}
	
	var data;
	for(let i = 0; i <= orderList.length-1; i++)
	{
		  data += '<tr scope="row">';
	    data += '<td scope="col">'+orderList[i][0].name +'</td>';
	      data += '<td scope="col">'+orderList[i][0].price+' RSD </td>';
	      if(orderList[i][0].type == "DRINK")
	    	  data += '<td scope="col"> Drink </td>';
	      
	      else
	    	  data += '<td scope="col"> Food </td>';
	    	  data += '<td scope="col">'+ orderList[i][1] +'</td>';		    	 
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deleteOne(orderList['+i+']); return false;"> - 1 </td>';
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deteAll(orderList['+i+']); return false;"> Delete </td>';
	    	  data += '<tr>';	   
		
	}
	 
   $('#tableBodyPursh').append(data);
	
	
}

function deleteOne(article)
{
	console.log(article[0])
	for(let k=0; k <= orderList.length-1; k++)
		{
			if(orderList[k][0].idArticle == article[0].idArticle)
				{
					
					if(orderList[k][1] > 1)
					{
						var num = orderList[k][1] - 1;
						orderList[k][1] = num;	
						price -= article[0].price;

						document.getElementById("sumPrice").innerHTML = price; 
					
						exists = 1;
						break;
					}
				}
			
		}	
	
	var tableHeaderRowCount = 1;
	var table = document.getElementById('articlePursh');
	var rowCount = table.rows.length;
	for (var i = tableHeaderRowCount; i < rowCount; i++) {
	    table.deleteRow(tableHeaderRowCount);
	}
	
	var data;
	for(let i = 0; i <= orderList.length-1; i++)
	{
		  data += '<tr scope="row">';
	    data += '<td scope="col">'+orderList[i][0].name +'</td>';
	      data += '<td scope="col">'+orderList[i][0].price+' RSD </td>';
	      if(orderList[i][0].type == "DRINK")
	    	  data += '<td scope="col"> Drink </td>';
	      
	      else
	    	  data += '<td scope="col"> Food </td>';
	    	  data += '<td scope="col">'+ orderList[i][1] +'</td>';		    	 
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deleteOne(orderList['+i+']); return false;"> - 1 </td>';
	    	  
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deteAll(orderList['+i+']); return false;"> Delete </td>';
	    	  data += '<tr>';   
		
	}
	 
   $('#tableBodyPursh').append(data);
}

function deteAll(article)
{
	for(let k=0; k <= orderList.length-1; k++)
	{
		
		if(orderList[k][0].idArticle == article[0].idArticle)
			{	
				
				orderList.splice(k, 1);
				price -= (article[0].price * article[1]);

				document.getElementById("sumPrice").innerHTML = price; 
			
				//orderList[k][0].splice(i,1);
				
				break;
				
			}
		
	}	
	console.log("trenutna ");
	console.log(orderList);
	var tableHeaderRowCount = 1;
	var table = document.getElementById('articlePursh');
	var rowCount = table.rows.length;
	for (var i = tableHeaderRowCount; i < rowCount; i++) {
	    table.deleteRow(tableHeaderRowCount);
	}
	
	var data;
	for(let i = 0; i <= orderList.length-1; i++)
	{
		  data += '<tr scope="row">';
	    data += '<td scope="col">'+orderList[i][0].name +'</td>';
	      data += '<td scope="col">'+orderList[i][0].price+' RSD </td>';
	      if(orderList[i][0].type == "DRINK")
	    	  data += '<td scope="col"> Drink </td>';
	      
	      else
	    	  data += '<td scope="col"> Food </td>';
	    	  data += '<td scope="col">'+ orderList[i][1] +'</td>';		    	 
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deleteOne(orderList['+i+']); return false;"> - 1 </td>';
	    	  
	    	  data += '<td scope="col"><button id="addOrd" style="width:100%;"  class="btn btn-warning" onclick="deteAll(orderList['+i+']); return false;"> Delete </td>';
	    	  data += '<tr>';   
		
	}
	 
   $('#tableBodyPursh').append(data);
}


function create()
{
	if(price === 0)
		{
		 alert("Your order list is empty! Please select some food/drink :) ");
		}
	else
		{
		
		
		
		
		
		var articles = [];
		console.log();
		
		for(let i = 0; i <= orderList.length-1; i++)
			{			
				articles.push(
						{
							"idArticle": orderList[i][0].idArticle,
							"name": orderList[i][0].name,
							"quantity": orderList[i][1],
							"price": orderList[i][0].price*orderList[i][1]
						})
				
			}
		
		console.log(articles);
		console.log(price);
		
		$.ajax({
			type : "POST",
			url : "rest/order/saveOrder",
			data : JSON.stringify({
				articles : articles,
				idRestaurant : orderList[1][0].idRestaurant,
				restaurantName: $("#restaurantOption option:selected").text(),
				price: price,
				username: loggedUser.username 
			}),
			contentType : "application/json",
			dataType : 'json',
			success : function(data) {			
				alert("Your order has been created!");
				$(location).attr('href', 'http://localhost:8080/PocetniREST/customer.html');

					},
			error : function(message) {
				alert("Error!");
				$('#error').text(message);
				$('#error').show().delay(3000).hide();
				}
			});
		
		
		}
	
}
</script>
</body>
</html>
